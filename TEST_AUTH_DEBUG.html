<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug Tool</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .output { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; white-space: pre-wrap; word-break: break-all; }
        .error { border-left-color: #dc3545; background: #fff5f5; }
        .success { border-left-color: #28a745; background: #f5fff5; }
        input { width: 100%; padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Healthcare App - Auth Debug Tool</h1>

        <h2>Step 1: Login</h2>
        <input type="text" id="username" placeholder="Username" value="provider_demo">
        <input type="password" id="password" placeholder="Password" value="demo123">
        <button onclick="login()">Login</button>
        <div id="loginOutput"></div>

        <h2>Step 2: Check Token</h2>
        <button onclick="checkToken()">Check Stored Token</button>
        <button onclick="clearToken()">Clear Token</button>
        <div id="tokenOutput"></div>

        <h2>Step 3: Test API Call</h2>
        <input type="text" id="appointmentId" placeholder="Appointment ID" value="appt-drsarah-001">
        <button onclick="createVisit()">Create Visit from Appointment</button>
        <div id="visitOutput"></div>

        <h2>Step 4: Direct Token Test</h2>
        <textarea id="manualToken" placeholder="Paste token here to test" rows="3" style="width: 100%;"></textarea>
        <button onclick="testManualToken()">Test This Token</button>
        <div id="manualOutput"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const output = document.getElementById('loginOutput');

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                output.className = 'output success';

                if (data.access_token) {
                    localStorage.setItem('token', data.access_token);
                    output.innerHTML = `‚úÖ Login successful!\n\nToken: ${data.access_token.substring(0, 50)}...\n\nFull response:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    output.className = 'output error';
                    output.innerHTML = `‚ùå Login failed:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                output.className = 'output error';
                output.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        function checkToken() {
            const token = localStorage.getItem('token');
            const output = document.getElementById('tokenOutput');

            if (!token) {
                output.className = 'output error';
                output.innerHTML = '‚ùå No token found in localStorage';
                return;
            }

            const parts = token.split('.');
            output.className = 'output ' + (parts.length === 3 ? 'success' : 'error');

            let result = `Token found in localStorage:\n\n`;
            result += `Length: ${token.length} characters\n`;
            result += `Parts: ${parts.length} (should be 3)\n\n`;
            result += `First 100 chars:\n${token.substring(0, 100)}...\n\n`;

            if (parts.length === 3) {
                try {
                    const payload = JSON.parse(atob(parts[1]));
                    const exp = new Date(payload.exp * 1000);
                    const now = new Date();
                    const expired = now > exp;

                    result += `Decoded Payload:\n${JSON.stringify(payload, null, 2)}\n\n`;
                    result += `Expiration: ${exp.toLocaleString()}\n`;
                    result += `Expired: ${expired ? '‚ùå YES' : '‚úÖ NO'}\n`;
                } catch (e) {
                    result += `‚ö†Ô∏è Could not decode payload: ${e.message}`;
                }
            }

            output.innerHTML = result;
        }

        function clearToken() {
            localStorage.removeItem('token');
            document.getElementById('tokenOutput').className = 'output';
            document.getElementById('tokenOutput').innerHTML = 'Token cleared from localStorage';
        }

        async function createVisit() {
            const appointmentId = document.getElementById('appointmentId').value;
            const token = localStorage.getItem('token');
            const output = document.getElementById('visitOutput');

            if (!token) {
                output.className = 'output error';
                output.innerHTML = '‚ùå No token found. Please login first.';
                return;
            }

            output.className = 'output';
            output.innerHTML = '‚è≥ Creating visit...';

            try {
                console.log('Sending request with token:', token.substring(0, 50) + '...');
                console.log('Authorization header:', `Bearer ${token}`);

                const response = await fetch(`${API_URL}/api/visits/from-appointment/${appointmentId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    output.className = 'output success';
                    output.innerHTML = `‚úÖ Visit created successfully!\n\nVisit ID: ${data.id}\n\nFull response:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    output.className = 'output error';
                    output.innerHTML = `‚ùå API Error (${response.status}):\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                output.className = 'output error';
                output.innerHTML = `‚ùå Network Error: ${error.message}`;
            }
        }

        async function testManualToken() {
            const token = document.getElementById('manualToken').value.trim();
            const output = document.getElementById('manualOutput');

            if (!token) {
                output.className = 'output error';
                output.innerHTML = '‚ùå Please paste a token to test';
                return;
            }

            const parts = token.split('.');
            let result = `Token Analysis:\n\n`;
            result += `Length: ${token.length}\n`;
            result += `Parts: ${parts.length} (should be 3)\n\n`;

            if (parts.length === 3) {
                try {
                    const payload = JSON.parse(atob(parts[1]));
                    result += `‚úÖ Valid JWT format\n\n`;
                    result += `Payload:\n${JSON.stringify(payload, null, 2)}\n`;
                    output.className = 'output success';
                } catch (e) {
                    result += `‚ùå Invalid payload: ${e.message}`;
                    output.className = 'output error';
                }
            } else {
                result += `‚ùå Invalid JWT format (wrong number of parts)`;
                output.className = 'output error';
            }

            output.innerHTML = result;
        }

        // Auto-check token on load
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('tokenOutput').className = 'output';
                document.getElementById('tokenOutput').innerHTML = 'Token found in localStorage. Click "Check Stored Token" to view details.';
            }
        };
    </script>
</body>
</html>
